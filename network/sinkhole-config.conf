# ============================================================================
# ZORBOX SINKHOLE - Sandbox Network Isolation
# ============================================================================
# Bu sinkhole malware-nin real network-ə əlçat etməsini əngəlləyir
# Windows 10 Sandbox içində hər HTTP/HTTPS request burada sonlanır
#
# Ayırıcılar:
# - port 80 (HTTP)
# - port 443 (HTTPS)
# - port 8080 (Alternative HTTP)
# - Custom DNS responses
# ============================================================================

# Main process configuration
user nginx;
worker_processes auto;
error_log /var/log/nginx/sinkhole_error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Logging Format
    log_format sinkhole '$remote_addr - $remote_user [$time_local] '
                        '"$request" $status $body_bytes_sent '
                        '"$http_referer" "$http_user_agent" '
                        '"$http_x_forwarded_for"';

    access_log /var/log/nginx/sinkhole_access.log sinkhole;
    error_log /var/log/nginx/sinkhole_error.log warn;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 20M;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss;

    # ========================================================================
    # HTTP Server - Port 80
    # ========================================================================
    server {
        listen 80 default_server;
        listen [::]:80 default_server;
        
        server_name _;

        # Malware C&C kontrolu əngəlləmə
        location ~* /(admin|update|check|ping|beacon) {
            access_log /var/log/nginx/sinkhole_c2_attempts.log sinkhole;
            
            return 200 'OK';
            add_header Content-Type text/plain;
            add_header X-Sinkhole-Response "true";
        }

        # Download request-ləri block
        location ~* \.(exe|dll|bat|ps1|scr|vbs|js)$ {
            access_log /var/log/nginx/sinkhole_malware_downloads.log sinkhole;
            
            return 403;
            add_header Content-Type text/plain;
            add_header X-Blocked "Executable files are not allowed";
        }

        # Fake success responses - malware "thinking" hərəkətini fake edir
        location ~* /(api|rest|json|xml) {
            default_type application/json;
            return 200 '{"status":"ok","code":200,"message":"success"}';
        }

        # Default location - hər şeyi 200 ilə cavab ver
        location / {
            default_type text/html;
            return 200 '<!DOCTYPE html>
<html>
<head>
    <title>Offline</title>
</head>
<body>
    <h1>Connection Established</h1>
    <p>You are currently running in a sandboxed environment.</p>
    <p>All network traffic is being monitored and logged.</p>
</body>
</html>';
        }

        # Analytics/Tracking services - Fake 204 No Content
        location ~* /(analytics|metrics|tracking|beacon|telemetry) {
            access_log /var/log/nginx/sinkhole_tracking.log sinkhole;
            return 204;
        }

        # 404 handler
        error_page 404 /404.html;
        location = /404.html {
            internal;
            default_type text/html;
            return 404 '<!DOCTYPE html><html><body><h1>404 Not Found</h1></body></html>';
        }
    }

    # ========================================================================
    # HTTPS Server - Port 443 (Self-signed certificate)
    # ========================================================================
    server {
        listen 443 ssl http2 default_server;
        listen [::]:443 ssl http2 default_server;

        server_name _;

        # SSL Configuration
        ssl_certificate /etc/nginx/certs/fake-cert.pem;
        ssl_certificate_key /etc/nginx/certs/fake-key.pem;
        
        # SSL protocols və ciphers
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';
        ssl_prefer_server_ciphers on;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;

        # Security headers
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-XSS-Protection "1; mode=block" always;

        # Malware C&C kontrolu
        location ~* /(admin|update|check|ping|beacon|c2|command|control) {
            access_log /var/log/nginx/sinkhole_c2_https.log sinkhole;
            
            default_type application/json;
            return 200 '{"status":"ok","error":null,"data":{}}';
        }

        # Executable files blocked
        location ~* \.(exe|dll|bat|ps1|scr|vbs|js)$ {
            access_log /var/log/nginx/sinkhole_malware_downloads_https.log sinkhole;
            return 403;
        }

        # API responses
        location ~* /(api|rest|json|xml) {
            default_type application/json;
            return 200 '{"result":"success","error":null,"status_code":200}';
        }

        # Analytics/Tracking
        location ~* /(analytics|metrics|tracking|beacon|telemetry) {
            return 204;
        }

        # Default
        location / {
            default_type text/html;
            return 200 '<!DOCTYPE html>
<html>
<head>
    <title>Secure Connection</title>
</head>
<body>
    <h1>Secure Connection Established</h1>
    <p>HTTPS sandbox environment active.</p>
</body>
</html>';
        }
    }

    # ========================================================================
    # HTTP Server - Port 8080 (Alternative)
    # ========================================================================
    server {
        listen 8080 default_server;
        listen [::]:8080 default_server;

        server_name _;

        # C&C control attempts
        location ~* /(admin|update|check|ping|beacon|c2|command) {
            access_log /var/log/nginx/sinkhole_c2_alt.log sinkhole;
            return 200 'OK';
        }

        # Executable downloads
        location ~* \.(exe|dll|bat|ps1|scr)$ {
            access_log /var/log/nginx/sinkhole_exe_downloads.log sinkhole;
            return 403;
        }

        # Default
        location / {
            default_type text/plain;
            return 200 'Sinkhole Response OK';
        }
    }

    # ========================================================================
    # Status/Monitoring Server - Port 8081 (Internal)
    # ========================================================================
    server {
        listen 8081 default_server;
        server_name _;
        access_log off;

        location /nginx_status {
            stub_status on;
            access_log off;
            allow 172.20.30.0/24;  # analysis_net subnet
            allow 172.20.0.0/16;   # Docker internal
            deny all;
        }

        location /health {
            default_type text/plain;
            return 200 'Sinkhole healthy';
        }
    }
}
